<!--
SPDX-FileCopyrightText: 2025 NONE

SPDX-License-Identifier: Unlicense
-->

# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a homelab PKI (Public Key Infrastructure) management repository that combines Kubernetes cluster deployment with certificate authority operations. The project provides infrastructure-as-code for a complete PKI solution using HashiCorp Vault, containerized CA operations, and GitOps deployment via Flux.

## Architecture

The repository follows a multi-layered architecture:

### Core Components
- **K0s Cluster Management**: K0s configuration with kustomize overlays for single-node controller+worker deployment
- **Flux GitOps**: Declarative cluster state management using HelmReleases and HelmRepositories
- **Certificate Authority Container**: Containerized PKI operations using OpenSSL with UBI9 base image
- **Vault Integration**: Terraform configuration for Vault PKI backends and SSH CA setup

### Directory Structure
- `k0s/`: K0s cluster configuration with kustomization patches for host role assignment
- `flux/`: GitOps manifests including HelmReleases for Vault, MetalLB, Traefik, OpenEBS, External-DNS
- `gen-ca/`: Containerized CA generation scripts with OpenSSL configurations for root and signing CAs
- `vault/`: Terraform configurations for Vault PKI engine setup and SSH certificate authority
- `metallb/`: Load balancer IP pool and L2 advertisement configurations

## Common Commands

### Environment Setup
```bash
# Enter Nix development shell with all dependencies
nix develop

# Environment variables are automatically set:
# - PROJECT_ROOT: Git repository root
# - CACHE_DIR: $PROJECT_ROOT/.cache
# - KUBECONFIG: $CACHE_DIR/.kube/config
```

### K0s Cluster Operations
```bash
# Generate k0sctl configuration
make generate-config

# Apply cluster configuration
make k0s-apply

# Generate and install kubeconfig
make k0s-config

# Reset cluster (destructive)
make k0s-reset
```

### Certificate Authority Operations
```bash
# Generate root CA
make ca-generate-root ROOT_CA_DIR=/path/to/root-ca

# Generate signing CA
make ca-generate-signing ROOT_CA_DIR=/path/to/root-ca SIGNING_CA_DIR=/path/to/signing-ca

# Issue server certificate
make ca-issue-server-cert SIGNING_CA_DIR=/path/to/signing-ca CERT_OUTPUT_DIR=/path/to/output ARGS="server.example.com"

# Issue client certificate
make ca-issue-client-cert SIGNING_CA_DIR=/path/to/signing-ca CERT_OUTPUT_DIR=/path/to/output ARGS="client-name"

# Sign intermediate CA
make ca-sign-intermediate ROOT_CA_DIR=/path/to/root-ca CERT_OUTPUT_DIR=/path/to/output ARGS="intermediate-ca-name"

# Install root CA to system trust store
make ca-install-certs ROOT_CA_DIR=/path/to/root-ca
```

### Flux Operations
```bash
# Apply Flux configuration to cluster
make flux-apply
```

## Key Configuration Details

### Certificate Authority Container
- Uses entrypoint.sh with command routing for CA operations
- Supports root CA generation, signing CA creation, certificate issuance
- Volume mounts: `/root-ca`, `/signing-ca`, `/output` for certificate storage
- OpenSSL configurations in `root-ca.conf` and `signing-ca.conf`

### K0s Configuration
- Single-node deployment with controller+worker role and no taints
- Kustomize patches for host configuration in `k0s.Cluster.patch.yaml`
- Base configuration generated by k0sctl init command

### Flux HelmReleases
- Vault (HashiCorp) for PKI backend
- MetalLB for load balancing with custom IP pools
- Traefik as ingress controller
- OpenEBS for persistent storage
- External-DNS with OpnSense webhook integration

### Makefile Environment Variables
- `CONTAINER_ENGINE`: Container runtime (default: docker)
- `PROJECT_ROOT`: Repository root directory
- `CACHE_DIR`: Cache directory for generated files
- `K0SCTL_*`: K0s cluster configuration variables
- `*_CA_DIR`: Certificate authority directory paths

## Important Notes

- All Makefile targets have .PHONY declarations placed after their respective target steps
- The gen-ca container expects specific volume mount points and environment variables
- Flux configurations use semantic versioning with wildcard patch versions
- Vault Terraform configuration includes both PKI engines and SSH CA setup with predefined TTL values
