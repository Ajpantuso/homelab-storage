<!--
SPDX-FileCopyrightText: 2025 NONE

SPDX-License-Identifier: Unlicense
-->

# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a homelab infrastructure repository that provides Kubernetes cluster deployment and GitOps management. The project uses K0s for cluster management and Flux for declarative infrastructure-as-code deployment of core components like MetalLB, Traefik, External-DNS, and Cert-Manager.

## Architecture

The repository follows a multi-layered architecture:

### Core Components
- **K0s Cluster Management**: K0s configuration with kustomize overlays for single-node controller+worker deployment
- **Flux GitOps**: Declarative cluster state management using HelmReleases, GitRepositories, and Kustomizations
- **Ingress and Load Balancing**: Traefik ingress controller with MetalLB for load balancing
- **DNS and Certificates**: External-DNS for dynamic DNS management and Cert-Manager for TLS certificates

### Directory Structure
- `k0s/`: K0s cluster configuration with kustomization patches for host role assignment
- `flux/`: GitOps manifests including HelmReleases for MetalLB, Traefik, External-DNS, and Cert-Manager

## Common Commands

### Environment Setup
```bash
# Enter Nix development shell with all dependencies
nix develop

# Environment variables are automatically set:
# - PROJECT_ROOT: Git repository root
# - CACHE_DIR: $PROJECT_ROOT/.cache
# - KUBECONFIG: $CACHE_DIR/.kube/config
```

### K0s Cluster Operations
```bash
# Generate k0sctl configuration
make generate-config

# Apply cluster configuration
make k0s-apply

# Generate and install kubeconfig
make k0s-config

# Reset cluster (destructive)
make k0s-reset
```

### Flux Operations
```bash
# Apply Flux configuration to cluster
make flux-apply
```

## Key Configuration Details

### K0s Configuration
- Single-node deployment with controller+worker role and no taints
- Kustomize patches for host configuration in `k0s.Cluster.patch.yaml`
- Base configuration generated by k0sctl init command

### Flux Resources

#### HelmReleases
- MetalLB for load balancing with custom IP pools
- Traefik as ingress controller
- External-DNS with OpnSense webhook integration
- Cert-Manager for TLS certificate management

#### Kustomizations
- **Cert-Manager**: Local kustomization for cert-manager resources
- **MetalLB**: Local kustomization for MetalLB IP pool and L2 advertisement configs
- **RBAC**: Role-based access control configurations

### Makefile Environment Variables
- `CONTAINER_ENGINE`: Container runtime (default: docker)
- `PROJECT_ROOT`: Repository root directory
- `CACHE_DIR`: Cache directory for generated files
- `K0SCTL_*`: K0s cluster configuration variables

## Important Notes

- All Makefile targets have .PHONY declarations placed after their respective target steps
- Flux configurations use semantic versioning with wildcard patch versions
