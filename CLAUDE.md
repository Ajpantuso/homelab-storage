<!--
SPDX-FileCopyrightText: 2025 NONE

SPDX-License-Identifier: Unlicense
-->

# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a homelab storage infrastructure repository that combines Kubernetes cluster deployment with persistent storage management. The project provides infrastructure-as-code for a complete storage solution using DirectPV CSI driver, MinIO object storage, and GitOps deployment via Flux.

## Architecture

The repository follows a multi-layered architecture:

### Core Components
- **K0s Cluster Management**: K0s configuration with kustomize overlays for single-node controller+worker deployment
- **DirectPV CSI Storage**: MinIO DirectPV for direct persistent volume management with local storage
- **MinIO Object Storage**: S3-compatible object storage deployed via Helm
- **Flux GitOps**: Declarative cluster state management using HelmReleases, GitRepositories, and Kustomizations

### Directory Structure
- `k0s/`: K0s cluster configuration with kustomization patches for host role assignment
- `flux/`: GitOps manifests including HelmReleases for MetalLB, Traefik, MinIO, External-DNS, Cert-Manager, and DirectPV GitRepository/Kustomization
- `metallb/`: Load balancer IP pool and L2 advertisement configurations

## Common Commands

### Environment Setup
```bash
# Enter Nix development shell with all dependencies
nix develop

# Environment variables are automatically set:
# - PROJECT_ROOT: Git repository root
# - CACHE_DIR: $PROJECT_ROOT/.cache
# - KUBECONFIG: $CACHE_DIR/.kube/config
```

### K0s Cluster Operations
```bash
# Generate k0sctl configuration
make generate-config

# Apply cluster configuration
make k0s-apply

# Generate and install kubeconfig
make k0s-config

# Reset cluster (destructive)
make k0s-reset
```

### Flux Operations
```bash
# Apply Flux configuration to cluster
make flux-apply
```

### DirectPV Storage Operations
```bash
# Initialize DirectPV (updates CSINodes and initializes drives)
make init-directpv

# Update all CSINodes with DirectPV driver information
make update-csinodes

# Initialize drives on DirectPV nodes
make initialize-drives
```

## Key Configuration Details

### K0s Configuration
- Single-node deployment with controller+worker role and no taints
- Kustomize patches for host configuration in `k0s.Cluster.patch.yaml`
- Base configuration generated by k0sctl init command

### Flux Resources

#### HelmReleases
- MetalLB for load balancing with custom IP pools
- Traefik as ingress controller
- MinIO for S3-compatible object storage
- External-DNS with OpnSense webhook integration
- Cert-Manager for TLS certificate management

#### Kustomizations
- **DirectPV**: Deployed from upstream MinIO repository (https://github.com/minio/directpv/resources/base)
  - Configured as default StorageClass via patch
  - Provides CSI driver for direct local volume management
  - Target namespace: `directpv`
- **Cert-Manager**: Local kustomization for cert-manager resources
- **MetalLB**: Local kustomization for MetalLB IP pool and L2 advertisement configs
- **RBAC**: Role-based access control configurations

### Makefile Environment Variables
- `CONTAINER_ENGINE`: Container runtime (default: docker)
- `PROJECT_ROOT`: Repository root directory
- `CACHE_DIR`: Cache directory for generated files
- `K0SCTL_*`: K0s cluster configuration variables

## Important Notes

- All Makefile targets have .PHONY declarations placed after their respective target steps
- Flux configurations use semantic versioning with wildcard patch versions
- DirectPV is deployed via Flux Kustomization from upstream repository, not local manifests
- DirectPV StorageClass is patched to be the default storage class with annotation `storageclass.kubernetes.io/is-default-class: "true"`
- CSINode updates add DirectPV driver information with topology keys for proper volume scheduling
- The `init-directpv` target automates both CSINode patching and drive initialization
